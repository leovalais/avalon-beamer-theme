\mode<presentation>

% Requirement
\RequirePackage{xcolor}
\RequirePackage{tikz}
\RequirePackage{scrextend} % addmargin
\RequirePackage[most]{tcolorbox}
\RequirePackage[absolute,overlay]{textpos} % textblock* [text independant,above everything else]
\RequirePackage{fontawesome}
\RequirePackage{applecolors}
\RequirePackage{flatbox}

\usetikzlibrary{calc,decorations.pathmorphing,patterns,shapes,positioning,fit}
\pgfdeclaredecoration{blueprintbyhand}{initial}{
    \state{initial}[width=+\pgfdecoratedinputsegmentremainingdistance,auto corner on length=1mm,]{
        \pgfpathcurveto%
        {% From
            \pgfqpoint{\pgfdecoratedinputsegmentremainingdistance}
                            {\pgfdecorationsegmentamplitude}
        }
        {%  Control 1
        \pgfmathrand
        \pgfpointadd{\pgfqpoint{\pgfdecoratedinputsegmentremainingdistance}{0pt}}
                        {\pgfqpoint{-\pgfdecorationsegmentaspect\pgfdecoratedinputsegmentremainingdistance}%
                                        {\pgfmathresult\pgfdecorationsegmentamplitude}
                        }
        }
        {%TO
        \pgfpointadd{\pgfpointdecoratedinputsegmentlast}{\pgfpoint{1pt}{1pt}}
        }
    }
    \state{final}{}
}

% Settings
\usecolortheme{avalon}
\usefonttheme{avalon}
\useinnertheme{avalon}
\useoutertheme{avalon}

%% HACK to make sure that the content of the slide uses the normal text
%%      fonts and colors
%%      https://github.com/matze/mtheme/issues/130#issuecomment-176499745
\def\beamer@framenotesbegin{% at beginning of slide
  \usebeamercolor[fg]{normal text}
  \gdef\beamer@noteitems{}%
  \gdef\beamer@notes{}%
}

\setbeamertemplate{navigation symbols}{}

\setbeamertemplate{itemize item}{\usebeamerfont{itemize item}\usebeamercolor[fg]{itemize item}\faCaretRight}
\setbeamertemplate{itemize subitem}{\usebeamerfont{itemize subitem}\usebeamercolor[fg]{itemize subitem}\faAngleRight}
\setbeamertemplate{itemize subsubitem}{\usebeamerfont{itemize subsubitem}\usebeamercolor[fg]{itemize subsubitem}\faCube}

\def\avalondarkmintedstyle{}

\newcommand{\ccft}[1]{
  \usebeamercolor{#1}
  \definecolor{avalon@ccft.fg}{named}{fg}
  \definecolor{avalon@ccft.bg}{named}{bg}
}

%%%
%%% Blueprints
%%%

% \def\bpbyhand{1}
\ifthenelse{\isundefined{\bpbyhand}}{
  \def\bpdecoration{}
}{
  \def\bpdecoration{blueprintbyhand}
}

\newcommand{\bp}[2][]{
  \ifthenelse{\isundefined{\bpbyhand}}{
    \node[decorate,draw=white,thick,#1]#2;
  }{
    \node[decorate,draw=white,#1]#2;
    \node[decorate,draw=white,#1,bend left]#2;
    \node[decorate,draw=white,#1,bend right]#2;
  }
}
\newcommand{\bparrow}[2][]{
  \draw[decorate,draw=white,thick,->,#1]#2;
}
\newcommand{\pbgroup}[3][left]{
  \node[draw=white,very thick,dashed,fit={#3}] (group#2) {};
  \node[#1=of group#2,rotate=90,anchor=center] () {\large\color{white}#2};
}

\newenvironment{blueprintframe}{
  \makeatletter
  \def\avalon@blueprint{1}
  \makeatother
  \begin{frame}
    \setbeamercolor{normal text}{fg=white}
    \usebeamercolor[fg]{normal text}
  }{
  \end{frame}
  \makeatletter
  \undef\avalon@blueprint
  \makeatother
}

\newenvironment{blueprint}[2][]{
  \begin{tikzpicture}[#1]
    \shade[inner color=avalon@blpint,outer color=avalon@blpext,draw=black] (0,0) rectangle #2;
    \draw[step=2.5mm,avalon@blpmin,very thin] (0,0) grid #2;
    \draw[step=1cm,avalon@blpmaj] (0,0) grid #2;
  }{
  \end{tikzpicture}
}


%%%
%%% Standouts
%%%
\providebool{avalon@standout}
\define@key{beamerframe}{standout}[true]{
  \booltrue{avalon@standout}
  \begingroup
  \usebeamercolor{background}
  \colorlet{avalon@tmpbg}{bg}
  \usebeamercolor{primary color}
  \colorlet{avalon@tmpfg}{fg}
  \setbeamercolor{background}{bg=avalon@tmpfg}
  \setbeamercolor{normal text}{fg=avalon@tmpbg}
  \setbeamercolor{block body}{fg=avalon@tmpbg}
  \setbeamercolor{block body example}{fg=avalon@tmpbg}
  \setbeamercolor{block body alerted}{fg=avalon@tmpbg}
  \setbeamercolor{itemize item}{fg=avalon@tmpbg}
  \setbeamercolor{itemize subitem}{fg=avalon@tmpbg}
  \setbeamercolor{itemize subsubitem}{fg=avalon@tmpbg}
  \setbeamercolor{page number in head/foot}{fg=avalon@tmpbg}
}
\apptocmd{\beamer@reseteecodes}{
  \ifbool{avalon@standout}{
    \endgroup
    \boolfalse{avalon@standout}
  }{}
}{}{}

% \providebool{avalon@standout}
% \define@key{beamerframe}{standout}[true]{
%   \booltrue{avalon@standout}
%   \begingroup
%   \usebeamercolor{background}
%   \colorlet{avalon@tmpbg}{bg}
%   \usebeamercolor{primary color}
%   \colorlet{avalon@tmpfg}{fg}
%   \setbeamercolor{background}{bg=avalon@tmpfg}
%   \setbeamercolor{normal text}{fg=avalon@tmpbg}
%   \setbeamercolor{block body}{fg=avalon@tmpbg}
%   \setbeamercolor{block body example}{fg=avalon@tmpbg}
%   \setbeamercolor{block body alerted}{fg=avalon@tmpbg}
%   \setbeamercolor{itemize item}{fg=avalon@tmpbg}
%   \setbeamercolor{itemize subitem}{fg=avalon@tmpbg}
%   \setbeamercolor{itemize subsubitem}{fg=avalon@tmpbg}
%   \setbeamercolor{page number in head/foot}{fg=avalon@tmpbg}
% }
% \apptocmd{\beamer@reseteecodes}{
%   \ifbool{avalon@standout}{
%     \endgroup
%     \boolfalse{avalon@standout}
%   }{}
% }{}{}

% \newenvironment{standoutframe}{
%   \makeatletter
%   \def\avalon@standout{1}
%   \makeatother
%   \begin{@empty}
%     \usebeamercolor{background}
%     \colorlet{avalon@tmpbg}{bg}
%     \usebeamercolor{primary color}
%     \colorlet{avalon@tmpfg}{fg}
%     \setbeamercolor{background}{bg=avalon@tmpfg}
%     \setbeamercolor{normal text}{fg=avalon@tmpbg}
%     \setbeamercolor{block body}{fg=avalon@tmpbg}
%     \setbeamercolor{block body example}{fg=avalon@tmpbg}
%     \setbeamercolor{block body alerted}{fg=avalon@tmpbg}
%     \setbeamercolor{itemize item}{fg=avalon@tmpbg}
%     \setbeamercolor{itemize subitem}{fg=avalon@tmpbg}
%     \setbeamercolor{itemize subsubitem}{fg=avalon@tmpbg}
%     \setbeamercolor{page number in head/foot}{fg=avalon@tmpbg}
%     \begin{frame}
%       \usebeamercolor{normal text}
%       \color{fg}
% }{%
%     \end{frame}
%   \end{@empty}
%   \makeatletter
%   \undef\avalon@standout
%   \makeatother
% }


%%%
%%% Popups
%%%
\newenvironment{popup}[2][(80mm,50mm)]{
  \begin{textblock*}{#2\paperwidth}[0.5, 0.5]#1
    \begin{overprint}
    }{
    \end{overprint}
  \end{textblock*}
}

%%%
%%% Blocks
%%%
\newenvironment{avalon@generic block}[3]{%
  \usebeamercolor{#2}
  \begin{tcolorbox}[blanker,borderline west={1pt}{3mm}{fg},left=2em,top=.10em,bottom=.10em]%
%   \begin{tcolorbox}[enhanced,skin=enhancedmiddle,
% frame hidden,borderline
% west={1pt}{3mm}{fg},colback=fg!10,left=0em,top=.10em,bottom=.10em,left skip=0mm]%
    % add item only if title exists%
    \ifthenelse{\equal{#1}{\@empty}}{}{%
      \color{fg}
      \usebeamerfont{#2}
      #1}

    \usebeamercolor[fg]{#3}
    \usebeamerfont{#3}
  }{%
  \end{tcolorbox}}
\renewenvironment{alertblock}[1]{%
  \begin{avalon@generic block}{#1}{block title alerted}{block body alerted}
  }{
  \end{avalon@generic block}}
\renewenvironment{exampleblock}[1]{%
  \begin{avalon@generic block}{#1}{block title example}{block body example}
  }{
  \end{avalon@generic block}}

\renewenvironment{block}[2][]{
  \begin{@empty}
    \ccft{block title}
    \ifthenelse{\equal{#1}{\@empty}}{
      \begin{tcolorbox}[blanker,borderline west={1pt}{3mm}{avalon@ccft.fg},left=2em,top=.10em,bottom=.10em]
      }{\begin{tcolorbox}[blanker,borderline west={1pt}{3mm}{#1},left=2em,top=.10em,bottom=.10em]}
        \ifthenelse{\equal{#2}{\@empty}}{}{%
          \ifthenelse{\equal{#1}{\@empty}}{\color{avalon@ccft.fg}}{\color{#1}}
          \usebeamerfont{block title}
          #2}

        \usebeamercolor[fg]{block body}
        \usebeamerfont{block body}
    }{
    \end{tcolorbox}
  \end{@empty}}
\renewenvironment{theorem}[1][Theorem]{
  \begin{block}[black]{#1}
  }{
  \end{block}
}

\mode<all>
